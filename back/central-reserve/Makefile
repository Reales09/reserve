# Makefile para Central Reserve Backend
# Uso: make [comando]

.PHONY: help build run test clean docker-build docker-dev docker-prod docker-stop docker-logs

# Variables
APP_NAME=central_reserve
DOCKER_IMAGE=central-reserve
DOCKER_TAG=latest

# Comandos principales
help: ## Mostrar esta ayuda
	@echo "Comandos disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Desarrollo local
build: ## Compilar la aplicaci√≥n
	go build -o bin/$(APP_NAME) ./cmd/main.go

run: ## Ejecutar la aplicaci√≥n localmente
	go run ./cmd/main.go

test: ## Ejecutar tests
	go test ./...

clean: ## Limpiar archivos generados
	rm -rf bin/
	go clean

# Docker
docker-build: ## Construir imagen Docker
	docker build -f docker/Dockerfile -t $(DOCKER_IMAGE):$(DOCKER_TAG) .

docker-dev: ## Levantar entorno de desarrollo con Docker
	@echo "üöÄ Levantando entorno de desarrollo..."
	cd docker && docker-compose -f docker-compose.dev.yml up -d
	@echo "‚úÖ Entorno listo!"
	@echo "üìã Servicios disponibles:"
	@echo "  - API: http://localhost:3050"
	@echo "  - Swagger: http://localhost:3050/docs"
	@echo "  - NATS Dashboard: http://localhost:8111"
	@echo "  - Adminer: http://localhost:8080"

docker-prod: ## Levantar entorno de producci√≥n con Docker
	@echo "üöÄ Levantando entorno de producci√≥n..."
	cd docker && docker-compose -f docker-compose.prod.yml up -d
	@echo "‚úÖ Entorno de producci√≥n listo!"

docker-stop: ## Detener contenedores Docker
	@echo "üõë Deteniendo contenedores..."
	cd docker && docker-compose -f docker-compose.dev.yml down
	cd docker && docker-compose -f docker-compose.prod.yml down

docker-logs: ## Ver logs de la aplicaci√≥n
	cd docker && docker-compose -f docker-compose.dev.yml logs -f central_reserve

docker-logs-all: ## Ver logs de todos los servicios
	cd docker && docker-compose -f docker-compose.dev.yml logs -f

# Scripts automatizados
build-and-run: ## Build y ejecutar con script automatizado
	./scripts/build-docker.sh dev

build-prod: ## Build para producci√≥n
	./scripts/build-docker.sh prod

# Utilidades
deps: ## Instalar dependencias
	go mod tidy
	go mod download

docs: ## Generar documentaci√≥n
	swag init -g cmd/main.go -o internal/infra/primary/http2/docs

# Base de datos
db-migrate: ## Ejecutar migraciones de base de datos
	@echo "üìä Ejecutando migraciones..."
	# Aqu√≠ puedes agregar comandos para migraciones si las tienes

db-reset: ## Resetear base de datos (¬°CUIDADO!)
	@echo "‚ö†Ô∏è  Reseteando base de datos..."
	cd docker && docker-compose -f docker-compose.dev.yml down -v
	cd docker && docker-compose -f docker-compose.dev.yml up -d postgres

# Email testing
test-email: ## Probar env√≠o de emails
	go run examples/email-starttls-test.go

# Health check
health: ## Verificar salud de los servicios
	@echo "üè• Verificando salud de servicios..."
	@curl -f http://localhost:3050/health || echo "‚ùå API no responde"
	@curl -f http://localhost:8111 || echo "‚ùå NATS Dashboard no responde"

# Limpieza completa
clean-all: ## Limpieza completa (Docker + binarios)
	@echo "üßπ Limpieza completa..."
	make clean
	make docker-stop
	docker system prune -f
	docker volume prune -f

# Informaci√≥n del sistema
info: ## Mostrar informaci√≥n del sistema
	@echo "üìä Informaci√≥n del sistema:"
	@echo "  - Go version: $(shell go version)"
	@echo "  - Docker version: $(shell docker --version)"
	@echo "  - Docker Compose version: $(shell docker-compose --version)"
	@echo "  - Contenedores activos:"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(central_reserve|postgres|redis|nats)" || echo "  No hay contenedores activos" 