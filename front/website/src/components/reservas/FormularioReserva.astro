---
import FormularioCliente from "./FormularioCliente.astro";
let mostrarFormulario = true;
---

<section
  class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-100 py-8 px-6 font-serif relative overflow-hidden"
>
  <!-- Background Pattern -->
  <div class="absolute inset-0 opacity-5">
    <div
      class="absolute top-0 left-0 w-96 h-96 bg-amber-300 rounded-full mix-blend-multiply filter blur-xl animate-pulse"
    >
    </div>
    <div
      class="absolute top-0 right-0 w-96 h-96 bg-orange-300 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-2000"
    >
    </div>
    <div
      class="absolute bottom-0 left-0 w-96 h-96 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-4000"
    >
    </div>
  </div>

  <div class="relative z-10 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">
        Haz tu <span class="text-gradient">Reserva</span>
      </h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Selecciona tus preferencias y disfruta de la mejor experiencia
        gastron칩mica italiana
      </p>
    </div>

    <!-- Progress Indicator -->
    <div class="flex justify-center mb-8">
      <div class="flex items-center space-x-3">
        <div class="flex items-center">
          <div
            class="w-8 h-8 bg-amber-600 rounded-full flex items-center justify-center text-white font-bold text-sm"
          >
            1
          </div>
          <span class="ml-2 text-amber-600 font-semibold text-sm"
            >Seleccionar</span
          >
        </div>
        <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
        <div class="flex items-center">
          <div
            class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-500 font-bold text-sm"
          >
            2
          </div>
          <span class="ml-2 text-gray-500 font-semibold text-sm">Confirmar</span
          >
        </div>
      </div>
    </div>

    <div
      id="reserva-container"
      class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8"
    >
      <!-- Invitados -->
      <div
        class="group relative bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-white/20 lg:col-span-3"
      >
        <div
          class="absolute inset-0 bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"
        >
        </div>
        <div class="relative z-10">
          <div class="text-center mb-4">
            <div
              class="w-12 h-12 bg-gradient-to-r from-amber-500 to-amber-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg"
            >
              <i class="fas fa-users text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">
              N칰mero de Personas
            </h3>
            <p class="text-gray-600 text-sm">
              Selecciona cu치ntas personas asistir치n
            </p>
          </div>

          <div class="flex justify-center items-center gap-4 mb-4">
            <button
              id="decrement"
              class="group/btn w-10 h-10 bg-gradient-to-r from-gray-100 to-gray-200 border-2 border-gray-300 rounded-full hover:from-amber-500 hover:to-amber-600 hover:border-amber-600 hover:text-white transition-all duration-300 transform hover:scale-110 shadow-lg hover:shadow-xl"
            >
              <i
                class="fas fa-minus text-base group-hover/btn:rotate-180 transition-transform duration-300"
              ></i>
            </button>

            <div class="relative">
              <span
                id="invitados"
                class="text-3xl font-bold text-amber-600 bg-white px-4 py-2 rounded-xl shadow-lg border-2 border-amber-200"
                >1</span
              >
              <div
                class="absolute -top-1 -right-1 w-5 h-5 bg-amber-500 rounded-full flex items-center justify-center"
              >
                <span class="text-white text-xs font-bold">游논</span>
              </div>
            </div>

            <button
              id="increment"
              class="group/btn w-10 h-10 bg-gradient-to-r from-gray-100 to-gray-200 border-2 border-gray-300 rounded-full hover:from-amber-500 hover:to-amber-600 hover:border-amber-600 hover:text-white transition-all duration-300 transform hover:scale-110 shadow-lg hover:shadow-xl"
            >
              <i
                class="fas fa-plus text-base group-hover/btn:rotate-180 transition-transform duration-300"
              ></i>
            </button>
          </div>

          <div class="text-center">
            <p
              class="text-xs text-gray-500 bg-amber-50 px-3 py-2 rounded-lg border border-amber-200"
            >
              <i class="fas fa-info-circle mr-2 text-amber-600"></i>
              M치ximo 20 personas por reserva
            </p>
          </div>
        </div>
      </div>

      <!-- Calendario -->
      <div
        class="group relative bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-white/20 lg:col-span-6"
      >
        <div
          class="absolute inset-0 bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"
        >
        </div>
        <div class="relative z-10">
          <div class="text-center mb-4">
            <div
              class="w-12 h-12 bg-gradient-to-r from-amber-500 to-amber-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg"
            >
              <i class="fas fa-calendar-alt text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">
              Selecciona la Fecha
            </h3>
            <p class="text-gray-600 text-sm">Elige el d칤a de tu reserva</p>
          </div>

          <div
            class="mb-4 flex items-center justify-between bg-white rounded-xl p-3 shadow-lg border border-amber-200"
          >
            <button
              id="prevMonth"
              class="group/btn px-4 py-2 text-gray-600 hover:text-amber-600 font-semibold transition-colors duration-300"
            >
              <i
                class="fas fa-chevron-left mr-2 group-hover/btn:scale-110 transition-transform duration-300"
              ></i>
              Anterior
            </button>
            <span
              id="calendarTitle"
              class="text-lg font-bold text-amber-600 px-4 py-2 bg-amber-50 rounded-lg"
              >Julio 2025</span
            >
            <button
              id="nextMonth"
              class="group/btn px-4 py-2 text-gray-600 hover:text-amber-600 font-semibold transition-colors duration-300"
            >
              Siguiente
              <i
                class="fas fa-chevron-right ml-2 group-hover/btn:scale-110 transition-transform duration-300"
              ></i>
            </button>
          </div>

          <div
            class="bg-white rounded-xl p-4 shadow-lg border border-amber-200"
          >
            <div
              class="grid grid-cols-7 gap-2 text-sm font-bold text-amber-600 mb-3"
            >
              <span class="text-center py-2">DOM</span>
              <span class="text-center py-2">LUN</span>
              <span class="text-center py-2">MAR</span>
              <span class="text-center py-2">MI칄</span>
              <span class="text-center py-2">JUE</span>
              <span class="text-center py-2">VIE</span>
              <span class="text-center py-2">S츼B</span>
            </div>
            <div id="calendarDays" class="grid grid-cols-7 gap-2 text-sm"></div>
          </div>
        </div>
      </div>

      <!-- Hora -->
      <div
        class="group relative bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-white/20 lg:col-span-3"
      >
        <div
          class="absolute inset-0 bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"
        >
        </div>
        <div class="relative z-10">
          <div class="text-center mb-4">
            <div
              class="w-12 h-12 bg-gradient-to-r from-amber-500 to-amber-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg"
            >
              <i class="fas fa-clock text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Elige la Hora</h3>
            <p class="text-gray-600 text-sm">Selecciona tu horario preferido</p>
          </div>

          <div class="relative">
            <select
              id="selectHora"
              class="w-full px-4 py-3 bg-white border-2 border-amber-200 rounded-xl text-gray-700 text-base font-semibold hover:border-amber-400 focus:outline-none focus:border-amber-500 focus:ring-4 focus:ring-amber-500/20 transition-all duration-300 shadow-lg appearance-none cursor-pointer"
            >
              <option value="">-- Selecciona una hora --</option>
            </select>
            <div
              class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none"
            >
              <i class="fas fa-chevron-down text-amber-600 text-base"></i>
            </div>
          </div>

          <div class="mt-4 text-center">
            <div
              class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-xl border border-green-200"
            >
              <i class="fas fa-check-circle text-green-600 text-lg mb-2"></i>
              <p class="text-xs text-green-700 font-medium">
                Horarios disponibles seg칰n el d칤a seleccionado
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmar -->
    <div class="text-center">
      <button
        id="confirmarReserva"
        class="group relative inline-flex items-center justify-center px-10 py-5 bg-gradient-to-r from-amber-500 via-amber-600 to-amber-700 text-white font-bold text-lg rounded-full hover:from-amber-600 hover:via-amber-700 hover:to-amber-800 transform hover:scale-110 hover:-translate-y-2 transition-all duration-500 shadow-2xl hover:shadow-amber-500/30 overflow-hidden"
      >
        <!-- Shine effect -->
        <div
          class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"
        >
        </div>

        <!-- Pulse ring -->
        <div
          class="absolute inset-0 rounded-full border-4 border-amber-400/50 animate-ping"
        >
        </div>

        <i
          class="fas fa-calendar-check mr-3 text-xl group-hover:rotate-12 transition-transform duration-300"
        ></i>
        <span class="relative z-10">Confirmar Reserva</span>
      </button>
    </div>

    <!-- Modal del Formulario Cliente -->
    <FormularioCliente />
  </div>
</section>

<script is:inline>
  // 游대 Recarga autom치tica solo una vez por sesi칩n
  if (!sessionStorage.getItem("refreshedOnce")) {
    sessionStorage.setItem("refreshedOnce", "true");
    location.reload();
  }

  let invitados = 1;
  let fechaSeleccionada = null;
  let horaSeleccionada = null;
  let selectedDay = null;
  let datosReserva = null;

  window.addEventListener("DOMContentLoaded", () => {
    const invitadosEl = document.getElementById("invitados");

    document.getElementById("increment").addEventListener("click", () => {
      if (invitados < 20) {
        invitados++;
        invitadosEl.textContent = invitados;
        // Add animation
        invitadosEl.classList.add("animate-pulse");
        setTimeout(() => invitadosEl.classList.remove("animate-pulse"), 300);
      }
    });

    document.getElementById("decrement").addEventListener("click", () => {
      if (invitados > 1) {
        invitados--;
        invitadosEl.textContent = invitados;
        // Add animation
        invitadosEl.classList.add("animate-pulse");
        setTimeout(() => invitadosEl.classList.remove("animate-pulse"), 300);
      }
    });

    // Calendario
    const calendarDays = document.getElementById("calendarDays");
    const calendarTitle = document.getElementById("calendarTitle");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");
    let date = new Date();

    const renderCalendar = () => {
      const month = date.getMonth();
      const year = date.getFullYear();
      const monthNames = [
        "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre",
      ];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      calendarDays.innerHTML = "";

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      for (let i = 0; i < firstDay; i++) {
        calendarDays.appendChild(document.createElement("div"));
      }

      for (let i = 1; i <= daysInMonth; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;

        const fechaBtn = new Date(year, month, i);
        fechaBtn.setHours(0, 0, 0, 0);

        const esPasado = fechaBtn < today;
        const esDomingo = fechaBtn.getDay() === 0;

        btn.className =
          "transition-all duration-300 p-3 rounded-lg font-semibold text-sm " +
          (esPasado || esDomingo
            ? "bg-gray-100 text-gray-400 cursor-not-allowed"
            : "bg-white hover:bg-amber-100 hover:text-amber-700 hover:scale-110 hover:shadow-lg border border-gray-200 hover:border-amber-300");

        if (!esPasado && !esDomingo) {
          btn.addEventListener("click", () => {
            if (selectedDay) {
              selectedDay.classList.remove(
                "bg-amber-500",
                "text-white",
                "shadow-lg",
                "border-amber-500",
              );
              selectedDay.classList.add("bg-white", "border-gray-200");
            }
            btn.classList.remove("bg-white", "border-gray-200");
            btn.classList.add(
              "bg-amber-500",
              "text-white",
              "shadow-lg",
              "border-amber-500",
            );
            selectedDay = btn;

            const monthNum = month + 1;
            fechaSeleccionada = `${year}-${monthNum.toString().padStart(2, "0")}-${i.toString().padStart(2, "0")}`;

            const selectHora = document.getElementById("selectHora");
            selectHora.innerHTML =
              '<option value="">-- Selecciona una hora --</option>';

            const seleccionada = new Date(year, month, i);
            seleccionada.setHours(0, 0, 0, 0);

            const diaSemana = seleccionada.getDay();
            let horasDisponibles = [];

            if ([1, 2, 3].includes(diaSemana)) {
              horasDisponibles = [
                "11:00 am",
                "12:00 pm",
                "01:00 pm",
                "02:00 pm",
                "03:00 pm",
                "04:00 pm",
                "05:00 pm",
                "06:00 pm",
                "07:00 pm",
              ];
            } else if ([4, 5].includes(diaSemana)) {
              horasDisponibles = [
                "11:00 am",
                "12:00 pm",
                "01:00 pm",
                "02:00 pm",
                "03:00 pm",
                "04:00 pm",
                "05:00 pm",
                "06:00 pm",
                "07:00 pm",
                "08:00 pm",
                "09:00 pm",
              ];
            } else if (diaSemana === 6) {
              horasDisponibles = [
                "11:00 am",
                "12:00 pm",
                "01:00 pm",
                "02:00 pm",
                "03:00 pm",
                "04:00 pm",
                "05:00 pm",
              ];
            }

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const ahora = new Date();
            const horaActual = ahora.getHours();

            let algunaHoraValida = false;

            horasDisponibles.forEach((horaTexto) => {
              const [hora, meridiano] = horaTexto.split(" ");
              let [h, m] = hora.split(":").map(Number);
              if (meridiano.toLowerCase() === "pm" && h !== 12) h += 12;
              if (meridiano.toLowerCase() === "am" && h === 12) h = 0;

              if (seleccionada.getTime() !== hoy.getTime() || h > horaActual) {
                const option = document.createElement("option");
                option.value = horaTexto;
                option.textContent = horaTexto;
                selectHora.appendChild(option);
                algunaHoraValida = true;
              }
            });

            if (!algunaHoraValida) {
              const option = document.createElement("option");
              option.disabled = true;
              option.textContent = "No hay horarios disponibles hoy";
              selectHora.appendChild(option);
            }
          });
        } else {
          btn.disabled = true;
        }

        calendarDays.appendChild(btn);
      }
    };

    renderCalendar();
    nextMonth.addEventListener("click", () => {
      date.setMonth(date.getMonth() + 1);
      renderCalendar();
    });
    prevMonth.addEventListener("click", () => {
      date.setMonth(date.getMonth() - 1);
      renderCalendar();
    });

    // Hora
    const selectHora = document.getElementById("selectHora");
    selectHora.addEventListener("change", () => {
      const horaTexto = selectHora.value;
      if (!horaTexto) {
        horaSeleccionada = null;
        return;
      }
      const [hora, meridiano] = horaTexto.split(" ");
      let [h, m] = hora.split(":").map(Number);
      if (meridiano.toLowerCase() === "pm" && h !== 12) h += 12;
      if (meridiano.toLowerCase() === "am" && h === 12) h = 0;
      horaSeleccionada = `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:00`;
    });

    const confirmarBtn = document.getElementById("confirmarReserva");
    confirmarBtn.addEventListener("click", () => {
      if (!fechaSeleccionada || !horaSeleccionada) {
        alert("Por favor selecciona la fecha y la hora");
        return;
      }

      datosReserva = {
        personas: invitados,
        fecha: fechaSeleccionada,
        hora: horaSeleccionada,
      };

      window.datosReserva = datosReserva;

      document.getElementById("resumenPersonas").textContent =
        datosReserva.personas;
      document.getElementById("resumenFecha").textContent = datosReserva.fecha;
      document.getElementById("resumenHora").textContent = datosReserva.hora;

      const modalCliente = document.getElementById("modalCliente");
      modalCliente.classList.remove("hidden");
      modalCliente.classList.add("flex");

      console.log("游릳 Esperando datos del cliente...");
    });
  });
</script>
