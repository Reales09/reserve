---
const { mostrar } = Astro.props;
---

<div
  id="modalCliente"
  class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50"
>
  <div
    class="bg-white rounded-xl p-6 w-full max-w-2xl grid grid-cols-1 md:grid-cols-2 gap-6 text-center relative animate-fade-in"
  >
    <!-- Resumen -->
    <div class="bg-gray-100 rounded-xl p-4">
      <h3 class="text-lg font-semibold text-[#4e563f] mb-3">Tu Reserva</h3>
      <ul class="text-left text-sm space-y-2">
        <li><strong>Personas:</strong> <span id="resumenPersonas">-</span></li>
        <li><strong>Fecha:</strong> <span id="resumenFecha">-</span></li>
        <li><strong>Hora:</strong> <span id="resumenHora">-</span></li>
      </ul>
    </div>

    <!-- Formulario cliente -->
    <div>
      <h2 class="text-2xl mb-4 text-[#4e563f]">Datos del Cliente</h2>

      <form id="formularioCliente" class="grid gap-4 text-left">
        <div>
          <label class="text-sm">Nombre completo</label>
          <input
            type="text"
            name="nombre"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#e9d8a6]"
          />
        </div>

        <div>
          <label class="text-sm">Tel√©fono</label>
          <input
            type="tel"
            name="telefono"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#e9d8a6]"
          />
        </div>

        <div>
          <label class="text-sm">Email</label>
          <input
            type="email"
            name="email"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#e9d8a6]"
          />
        </div>

        <div class="flex justify-between items-center mt-4">
          <button
            type="button"
            id="cerrarFormulario"
            class="text-sm text-red-500 hover:underline"
          >
            Cancelar
          </button>
        </div>

        <button
          type="submit"
          class="mt-4 bg-[#e9d8a6] text-black px-6 py-2 rounded hover:bg-[#4e563f] hover:text-white transition"
        >
          Enviar
        </button>
      </form>
    </div>
  </div>

  <script is:inline>
    window.addEventListener("DOMContentLoaded", () => {
      const cerrarBtn = document.getElementById("cerrarFormulario");
      const modal = document.getElementById("modalCliente");
      const formulario = document.getElementById("formularioCliente");

      let cuentaRegresiva;

      function cerrarModal() {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        if (cuentaRegresiva) clearInterval(cuentaRegresiva);
      }

      cerrarBtn?.addEventListener("click", cerrarModal);

      // Mostrar resumen en modal
      const resumenPersonas = document.getElementById("resumenPersonas");
      const resumenFecha = document.getElementById("resumenFecha");
      const resumenHora = document.getElementById("resumenHora");

      const reserva = window.datosReserva || {};
      if (resumenPersonas && resumenFecha && resumenHora) {
        resumenPersonas.textContent = reserva.personas ?? "-";
        resumenFecha.textContent = reserva.fecha ?? "-";
        resumenHora.textContent = reserva.hora ?? "-";
      }

      // Env√≠o del formulario completo
      formulario?.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearInterval(cuentaRegresiva);

        const formData = new FormData(formulario);
        const cliente = {
          name: formData.get("nombre"),
          phone: formData.get("telefono"),
          email: formData.get("email"),
          dni: "No aplica", // Asignar "No aplica" como valor por defecto
        };

        const reserva = window.datosReserva || {};

        // üö´ Ya no convertir a UTC. Solo crea fecha local directa
        const [year, month, day] = reserva.fecha.split("-");
        const [hora, minuto] = reserva.hora.split(":");

        // Crea fecha directamente en hora local del navegador (no UTC)
        const startInColombia = new Date(
          Number(year),
          Number(month) - 1, // Mes empieza desde 0
          Number(day),
          Number(hora),
          Number(minuto),
          0
        );

        // Fin: dos horas despu√©s
        const endInColombia = new Date(
          startInColombia.getTime() + 2 * 60 * 60 * 1000
        );

        if (isNaN(startInColombia.getTime())) {
          alert("‚ö†Ô∏è Fecha y hora inv√°lidas. Verifica los campos.");
          return;
        }

        const datosReserva = {
          ...cliente,
          number_of_guests: reserva.personas,
          restaurant_id: 1,
          start_at: startInColombia.toISOString(),
          end_at: endInColombia.toISOString(),
        };

        console.log("‚úÖ Enviando al backend:", datosReserva);

        try {
          // Usar la URL del servidor de producci√≥n
          const apiUrl = "http://3.220.183.29:3050/api/v1/reserves";
            
          const response = await fetch(
            apiUrl,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(datosReserva),
            }
          );

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              message: "Error sin detalles.",
            }));
            console.error("Detalles del error:", errorData);
            throw new Error(
              `Error ${response.status}: ${
                errorData.message || "No se pudo crear la reserva"
              }`
            );
          }

          alert("‚úÖ Reserva registrada exitosamente");
          cerrarModal();
        } catch (err) {
          console.error("‚ùå Error al enviar la reserva:", err);
          alert("Hubo un problema al registrar tu reserva.");
        }
      });
    });
  </script>
</div>
